<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Livro Didático Digital</title>

<style>
:root{ --azul:#2563eb; --cinza:#1f2937; }

body{ margin:0; font-family:"Segoe UI", Arial, sans-serif; background:#f2f4f7; }

header{
  background:var(--cinza);
  color:#fff;
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header h1{ font-size:18px; margin:0; }

.menu-btn{ font-size:22px; cursor:pointer; display:none; }

main{ display:flex; height:calc(100vh - 60px); }

nav{
  width:320px;
  background:#fff;
  border-right:1px solid #e5e7eb;
  padding:16px;
  overflow-y:auto;
}

nav.oculto{ transform:translateX(-100%); }

.unidade{ margin-bottom:12px; border:1px solid #e5e7eb; border-radius:8px; }

.unidade-titulo{ background:var(--azul); color:#fff; padding:12px 16px; font-weight:600; cursor:pointer; }

.capitulos{ display:none; padding:10px 16px; background:#f9fafb; }

.capitulos h4{ margin:10px 0 6px; }

.capitulos ul{ list-style:none; padding:0; }

.capitulos li{ margin:6px 0; }

.capitulos a{ cursor:pointer; text-decoration:none; color:#1d4ed8; font-size:15px; }

.capitulos a.concluido{ color:#16a34a; font-weight:600; }

section{ flex:1; background:#fff; }

iframe{ width:100%; height:100%; border:none; }

/* MOBILE */
@media(max-width:900px){
  nav{
    position:absolute;
    top:60px;
    left:0;
    height:calc(100vh - 60px);
    z-index:10;
    transform:translateX(-100%);
    transition:transform .3s ease;
  }

  nav.ativo{ transform:translateX(0); }

  .menu-btn{ display:block; }
}
</style>
</head>

<body>

<header>
  <h1>Livro Didático Digital</h1>
  <span class="menu-btn" onclick="toggleMenu()">☰</span>
</header>

<main>
  <nav id="indice"></nav>
  <section>
    <iframe id="viewer"></iframe>
  </section>
</main>

<script>
const owner = "profkleidivaldo";
const repo  = "livroteste";
const branch = "main";

const pagesBase = `https://${owner}.github.io/${repo}`;
const apiBase   = `https://api.github.com/repos/${owner}/${repo}/contents?ref=${branch}`;

const progresso = JSON.parse(localStorage.getItem("progressoLivro") || "{}");

function salvarProgresso(p){
  progresso[p]=true;
  localStorage.setItem("progressoLivro",JSON.stringify(progresso));
}

function toggleMenu(){
  document.getElementById("indice").classList.toggle("ativo");
}

/* ===== CAPA DO LIVRO (ACRÉSCIMO) ===== */
const capaHTML = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<style>
body{
  margin:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#f2f4f7;
  height:100vh;
}
img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
}
</style>
</head>
<body>
  <img src="https://i.postimg.cc/Z5jmTMk5/Capa-de-Livro-Educacional-Matematica-Infantil-Divertido-Bege-Marrom.png" alt="Capa do Livro">
</body>
</html>
`;

const viewer = document.getElementById("viewer");
viewer.src = URL.createObjectURL(new Blob([capaHTML], { type: "text/html" }));
/* ===== FIM DA CAPA ===== */

async function carregarLivro(){
  const res = await fetch(apiBase);
  const dados = await res.json();

  const indice = document.getElementById("indice");

  const unidades = dados.filter(d=>d.type==="dir" && d.name.toLowerCase().startsWith("unidade"));

  for(const unidade of unidades){
    const uDiv=document.createElement("div"); uDiv.className="unidade";

    const uTitulo=document.createElement("div"); uTitulo.className="unidade-titulo";
    uTitulo.textContent=formatar(unidade.name);

    const capsDiv=document.createElement("div"); capsDiv.className="capitulos";

    uTitulo.onclick=()=>{ capsDiv.style.display=capsDiv.style.display==="block"?"none":"block"; };

    const capitulos=await fetch(unidade.url).then(r=>r.json());

    for(const cap of capitulos.filter(c=>c.type==="dir")){
      const h4=document.createElement("h4"); h4.textContent=formatar(cap.name);
      capsDiv.appendChild(h4);

      const ul=document.createElement("ul");
      const paginas=await fetch(cap.url).then(r=>r.json());

      paginas.filter(p=>p.name.endsWith('.html')).forEach(p=>{
        const li=document.createElement("li");
        const a=document.createElement("a");
        const caminho=`${unidade.name}/${cap.name}/${p.name}`;

        a.textContent=formatar(p.name.replace('.html',''));
        if(progresso[caminho]) a.classList.add('concluido');

        a.onclick=()=>{
          viewer.src=`${pagesBase}/${caminho}`;
          salvarProgresso(caminho);
          a.classList.add('concluido');
          if(window.innerWidth<900) toggleMenu();
        };

        li.appendChild(a);
        ul.appendChild(li);
      });

      capsDiv.appendChild(ul);
    }

    uDiv.appendChild(uTitulo);
    uDiv.appendChild(capsDiv);
    indice.appendChild(uDiv);
  }
}

function formatar(t){
  return t.replace(/[-_]/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
}

carregarLivro();
</script>

</body>
</html>
